package com.taotao.search.service.impl;

import java.util.ArrayList;
import java.util.List;

import org.apache.commons.lang3.StringUtils;
import org.apache.solr.client.solrj.SolrQuery;
import org.apache.solr.client.solrj.SolrServerException;
import org.apache.solr.client.solrj.impl.CloudSolrServer;
import org.apache.solr.client.solrj.response.QueryResponse;
import org.apache.solr.common.SolrDocument;
import org.apache.solr.common.SolrDocumentList;
import org.apache.solr.common.SolrInputDocument;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.taotao.common.pojo.TaoResult;
import com.taotao.manager.mapper.ItemMapper;
import com.taotao.manager.pojo.Item;
import com.taotao.search.service.SearchService;

@Service
public class SearchServiceImpl implements SearchService {

	@Autowired
	private CloudSolrServer cloudSolrServer;

	@Autowired
	private ItemMapper itemMapper;

	@Override
	public TaoResult<Item> search(String q, Integer page, Integer rows) {
		// 声明返回结果
		TaoResult<Item> taoResult = new TaoResult<>();

		// 创建搜索对象
		SolrQuery solrQuery = new SolrQuery();

		// 判断搜索关键词是否为非空
		if (StringUtils.isNotBlank(q)) {
			// 设置搜索语法
			solrQuery.setQuery("item_title:" + q + " AND item_status:1");
		} else {
			// 如果是空，搜索所有数据
			solrQuery.setQuery("item_status:1");
		}

		// 设置分页
		solrQuery.setStart((page - 1) * rows);
		solrQuery.setRows(rows);

		// 设置高亮
		// 开启高亮
		solrQuery.setHighlight(true);
		// 设置高亮字段
		solrQuery.addHighlightField("item_title");
		// 设置前缀
		solrQuery.setHighlightSimplePre("<font color='red'>");
		// 设置后缀
		solrQuery.setHighlightSimplePost("</font>");

		try {
			// 使用CloudSolrServer实现查询，返回response
			QueryResponse response = this.cloudSolrServer.query(solrQuery);

			// 解析response结果集，获取results
			SolrDocumentList results = response.getResults();

			// 声明存放商品的容器
			List<Item> list = new ArrayList<>();
			// 遍历results，封装返回结果，商品
			for (SolrDocument solrDocument : results) {
				// 创建商品对象
				Item item = new Item();

				// 设置商品数据
				// 商品id
				item.setId(Long.parseLong(solrDocument.get("id").toString()));
				// 商品item_title
				item.setTitle(solrDocument.get("item_title").toString());
				// 商品item_price
				item.setPrice(Long.parseLong(solrDocument.get("item_price").toString()));
				// 商品item_image
				item.setImage(solrDocument.get("item_image").toString());
				// 商品item_cid
				item.setCid(Long.parseLong(solrDocument.get("item_cid").toString()));
				// 商品item_status,不能获取，否则会空指针异常，因为之前的设置是不存储的

				// 封装好的商品放到商品的list容器中
				list.add(item);
			}

			// 封装返回对象taoResult
			taoResult.setRows(list);
			taoResult.setTotal(results.getNumFound());

		} catch (SolrServerException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}

		// 如果查询有异常，不能返回null，应该返回空对象
		return taoResult;
	}

	@Override
	public void addItem(Long itemId) {
		// 根据商品id查询商品数据
		Item item = this.itemMapper.selectByPrimaryKey(itemId);

		// 把商品数据用SolrInputDocument进行封装
		SolrInputDocument doc = new SolrInputDocument();

		// 赋值

		
		<field name="item_title" type="text_ik" indexed="true" stored="true" />
	    <field name="item_price" type="long" indexed="true" stored="true"  />       
	    <field name="item_image" type="string" indexed="false" stored="true" />    
	    <field name="item_cid" type="long" indexed="false" stored="true" />
	    <field name="item_status" type="int" indexed="true" stored="false" /> 
		// 把商品数据保存到索引库中

	}

}
